@using System.Linq
@model Forno.Models.Orderr
@{
    ViewBag.Title = "Conferma Ordine";
}

@{
    var deliveryTimeInMinutes = Model.OrderDetail
        .Select(d =>
        {
            // Estrai le ore e i minuti dalla stringa di DeliveryTime
            var timespan = TimeSpan.Parse(d.Product.DeliveryTime);
            return (int)timespan.TotalMinutes; // Converti il timespan in minuti totali
        });

    var averageDeliveryTime = deliveryTimeInMinutes.Any() ? Math.Ceiling(deliveryTimeInMinutes.Average()) : 0;
}
<div class="order-confirmation">
    <h2>Conferma dell'Ordine</h2>

    @if (Model != null)
    {
        <p>Grazie per il tuo ordine, @User.Identity.Name!</p>
        <p>Il tuo ordine numero @Model.OrderID è stato confermato e ora è in lavorazione.</p>

        <h3>Dettagli dell'Ordine:</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Prodotto</th>
                    <th>Quantità</th>
                    <th>Prezzo</th>
                    <th>Subtotale</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var detail in Model.OrderDetail)
                {
                    <tr>
                        <td>@detail.Product.Name</td>
                        <td>@detail.Quantity</td>
                        <td>@detail.Product.Price.ToString("C")</td>
                        <td>@((detail.Quantity * detail.Product.Price).ToString("C"))</td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="3">Totale</th>
                    <th>@Model.OrderDetail.Sum(d => d.Quantity * d.Product.Price).ToString("C")</th>
                </tr>
            </tfoot>
        </table>

        <div class="text-right">
            <p>Data Ordine: @Model.OrderDate.ToString("dd/MM/yyyy")</p>
            <p>Stato: @Model.Status</p>
            <span class="badge bg-dark text-light">Tempo di Consegna Stimato: @averageDeliveryTime minuti</span>

            <a href="@Url.Action("Index", "Home")" class="btn btn-primary">Torna alla Home</a>
        </div>
    }
    else
    {
        <span class="alert-danger opacity-75 align-content-center">Si è verificato un problema con la conferma del tuo ordine. Per favore contattaci per assistenza.</span>
    }
</div>